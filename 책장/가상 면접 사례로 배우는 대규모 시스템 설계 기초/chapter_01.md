# Chapter 01 : 사용자 수에 따른 규모 확장성

### 단일 서버

> 단일 서버는 서비스 운영에 있어 하나의 서버만 운영하는 경우를 말한다. 
> 클라이언트는 Domain 에 접근하면 DNS 에서 해당 도메인에 대한 IP 주소를 반환하고, 해당 주소 HTTP Request 를 서버 측으로 요청한다.

---

### 데이터 베이스

> 데이터 베이스는 관계형 데이터 베이스와 비 관계형 데이터 베이스로 구분 지을 수 있다. 관계형 데이터 베이스에는 MySQL, MsSQL, Oracle, H2 등이 있고, 비 관계형 데이터 베이스는 NoSQL 이라고 하는 MongoDB, Casndra 등의 제품이 있다. 

#### NoSQL

> NoSQL 는 Key-Value Store, Document Store, Graph Store, Column Store 로 나눌 수 있으며, NoSQL 은 관계형 데이터 베이스가 아니기 때문에 Join 연산은 지원하지 않는다. NoSQL 도입을 고려해야 하는 상황은 다음과 같다.

- 아주 낮은 지연 시간(Latency)이 요구되는 경우
- 다루는 데이터의 유형이 비정형(Unstructured) 이라 관계형 데이터가 아닌 경우
- JSON, XML, YAML 같은 직렬화 / 역직렬화만 하면 되는 경우
- 아주 많은 양의 데이터를 저장해야 하는 경우

---

### 수직적 / 수평적 규모 확장

> 서비스의 사용자가 늘어나면 기존 서버에 많은 부하가 발생하게 되는데, 이로 인해 서비스 운영이 중단될 수 있는 문제가 있다. 이러한 문제를 해결하기 위해서 다음과 같은 방법이 제시된다.

#### 수직적 규모 확장 (Scale Up)

> 서버의 물리적인 사양을 올려서 트래픽 처리를 높이는 방법이다. 하지만 물리적 사양을 높이는데는 한계가 있고, 그 한계에 다다르면 결국 수평적 규모로 서버를 확장하는 수 밖에 없다. 또한, 물리적 사양을 교체하는데에 대한 비용이 많이 소모되며, 단일 서버로 운영되기 때문에 서버의 한계에 다다르면 서비스가 중단되는 문제가 발생한다.

#### 수평적 규모 확장 (Scale Out)

> 일정 수준의 서버를 여러 대 두어 트래픽을 여러 서버로 분산 시켜 부하를 줄이는 방법이다. Scale Up 확장에 비해 비교적 적은 비용으로 많은 트래픽을 처리 할 수 있다는 장점이 있다. 
> 이 때, 로드 밸런서를 도입하여 클라이언트의 여러 요청을 어떤 기준으로 분산 시켜야 하는지 고려해야 한다.

#### 로드 밸런서

> 로드 밸런서란 부하 분산 집합(Load Balancing Set) 에 속한 서버들에게 트래픽 부하를 고르게 분산하도록 한다. 이 때, DNS 는 로드 밸런서의 IP 를 클라이언트에게 반환하고, 로드 밸런서는 클라이언트의 요청을 정해진 기준에 따라 트래픽을 분산하도록 한다.
> 로드 밸런서를 이용 했을 때의 장점은 다음과 같다.

- 서버가 중단 되더라도, 다른 서버가 동작하고 있기 때문에 서비스 중단을 피함과 동시에 서버 중단에 대해 빠르게 대처 할 수 있다.
- 특정한 조건에만 트래픽이 발생하는 경우, 유동적으로 서버를 추가하고 그 이후에 트래픽이 줄어들면 다시 서버를 제하여 서버 운용 비용을 절감 할 수 있다.

---

### 데이터 베이스 다중화

> 데이터 베이스 다중화는 서버 사이에 Master - Slave 관계를 설정하고, 데이터 원본은 Master DB 에 저장, 사본은 Slave DB 에 저장하여 쓰기 연산은 Master DB, 읽기 연산은 Slave DB 에서만 처리 할 수 있도록 한다.
> 데이터 베이스 다중화를 했을 때 얻을 수 이점은 다음과 같다.

- 하나의 DB 에서 쓰기와 읽기를 동시에 처리하는 것이 아니라 쓰기 연산은 Master, 읽기 연산은 Slave 처리하기에 각 DB 가 부담해야 하는 처리량이 줄어들어 성능이 향상된다.
- Scale Out 과 마찬가지로 알 수 없는 이유로 DB 가 중단 되더라도 다른 DB 가 실행 중이기 때문에 서비스 중단 없이 문제를 대처 할 수 있다.
- 여러 곳에 동일한 데이터를 분산 했기 때문에 데이터가 유실 되더라도 쉽게 복구 할 수 있다.

---

### 캐시

> 캐시 계층은 데이터가 잠시 보관되는 곳으로 데이터 베이스보다 훨씬 빠르게 동작한다. 보통 캐시는 하드 디스크가 아닌 RAM 과 같은 처리 속도가 빠른 곳에 데이터를 저장하여 더 느린 기본 스토리지 계층에 액세스해야 하는 필요를 줄임으로써 데이터 검색 성능을 높인다.
> 이러한 캐시는 일시적으로 저장하고 있기 때문에 영속성 상태가 유지되어야 한다면 절대 캐시를 사용해서는 안된다. 그럴 경우에는 데이터 베이스에 저장하도록 하자.
> 또한 캐시 시스템은 여러 전략으로 운용되는데, 대표적으로 Read-Through Caching Strategy(읽기 주도형 전략 캐시) 전략이 있다.
> 캐시 시스템을 도입할 때 유의 해야 할 점은 다음과 같다.

- **캐시는 어떤 상황에서 유용한가?**
  - 캐시 데이터는 기본적으로 휘발성 데이터이기 때문에 영속성 데이터를 보관하기에는 적합하지 않다. (데이터 방출 정책 및 캐시 만료기간 등)
- **캐시 데이터는 언제 만료되는가?**
  - 기본적으로 속도가 빠른 하드웨어들의 용량은 하드 디스크에 비해 작다. 때문에 적절하게 캐시 저장 공간을 관리해야 하는데 이때 캐시 만료 정책을 적용하는 것이 좋다.
  - 다만 캐시 만요기간이 너무 짧으면 오히려 더 자주 데이터 베이스를 읽어야 하기 때문에 성능 저하를 야기 할 수 있다.
- **장애에는 어떻게 대처할 것인가?**
  - 단일 캐시 서버로 서비스를 운영한다면 단일 장애 지점(SPOF, Single Point or Failing)이 되어버려 서비스가 중단될 수 있는 문제가 있다. 이는 여러 대의 캐시 서버로 분산하여 SPOF 를 대응하는 것이 필요하다.
- **캐시 메모리의 크기는 어떻게 산정할 것인가?**
  - 앞서 말한 것처럼 기본적오로 캐시 데이터가 저장하는 곳은 처리 속도가 빠른 대신 저장 공간의 크기가 작다. 때문에 적은 공간에 많은 캐시 데이터를 저장하려고 하면 기존 데이터가 밀리고 새로운 캐시 데이터가 저장되는데 이 때 캐시 서버의 성능을 떨어트리는 문제가 발생할 수 있다.
  - 때문에 데이터 방출 정책을 정립해야지 원활하게 캐시 시스템을 운영할 수 있는데, 대표적으로 LRU 정책이 있다. 
    - **LFU(Least Frequently Used) 란?**
      - 사용 빈도가 낮은 데이터를 먼저 내보내어 메모리 공간을 확보 할 수 있도록 하는 정책이다.

---

### CDN

> CDN 이란 콘텐츠 전송 네트워크로 웹 접근 시, 로딩이 오래 걸리는 데이터를 제 3자가 운영하는 서버의 네트워크에서 가져올 수 있도록 해 서버의 부하를 줄이도록 하는 방법이다. 주로 JS, CSS, 이미지, 동영상 등을 CDN 을 이용하여 캐싱하도록 한다.

---

### 무상태 계층

> 무상태 계층이란 기존에 웹 브라우저에 저장 중인 클라이언트의 상태 정보(세션 데이터나 토큰 등) 을 분리하여 외부에서 수평적으로 관리하도록 하는 전략이다.

#### 상태 정보 의존적인 아키텍처

> 세션을 생각해보자. 보통 세션을 사용하면 클라이언트 상태 정보를 서버에서 관리하게 된다. 이 때 Scale Out 으로 서버를 분산한다고 가정 했을 때, 클라이언트의 상태 정보는 분산된 서버 중 하나에 종속하게 된다. 그렇다면 클라이언트는 처음 접근한 분산 서버에 계속 접근해야 상태를 유지하면서 서비스를 이용할 수 있게 된다.
> 로드 밸런서에서 고정 세션 기능을 제공하여 이러한 전략을 유지할 수 있지만, 이는 로드 밸런서에 많은 부담을 주게 되며, 추가적인 서버 추가나 서버 장애에 대응하기 어려워진다.

#### 무상태 아키텍처

> 클라이언트의 상태 정보를 웹 브라우저나 웹 서버에서 직접 관리하는 것이 아니라 외부의 저장소에 저장하여 클라이언트와 웹 서버의 종속성을 떨어트리도록 하는 전략이다. 분산 서버를 운용할 때 무상태 아키텍처 전략을 사용한다면 분산 서버는 하나의 상태 저장소에 클라이언트의 상태 정보를 공유 할 수 있게 되어 로드 밸런서의 부하를 줄이고, 장애 대처나 규모 확장을 쉽게 할 수 있다는 이점이 있다.

---

### 데이터 센터

> 여러 곳의 데이터 센터를 이용하는 전략으로 장애가 없는 상황에서 클라이언트의 지리적 상황가 가장 가까운 곳의 데이터 센터로 안내 되도록 하는 방식이다. 이를 지리적 라우팅이라고 한다. 지리적 라우팅은 사용자의 위치에 따라 도메인 이름을 어떤 IP 주소로 반환할지 결정할 수 있는 DNS 서비스이다.

---

### 메세지 큐

> 메세지 큐는 메세지의 무손실을 보장하는 비동기 컴포넌트이다. 메세지 버퍼 역할을 하면서 비동기적으로 전송하는데, 메세지 큐를 이용하면 서버 간 결합이 느슨해져 규모 확장성이 보장되어야 하는 애플리케이션에서 적절하게 사용할 수 있다.
> 생산자는 소비자의 서비스가 운영 중이지 않더라도 메세지를 보낼 수 있고, 그 반대로도 메세지를 수신 할 수 있다.

---

### 데이터 베이스 규모 확장

> 분산 서버와 마찬가지로 수직적 확장과 수평적 확장으로 나눌 수 있다. 장단점은 분산 서버와 비슷하다. 
> 이 때 분산 데이터 베이스는 모두 같은 스키마를 이용하지만 데이터는 중복되지 않는다. 파티셔닝을 통해 데이터 베이스의 부하를 줄이도록 하는데, 이 때 어떻게 데이터를 분산 시켜 저장할지 샤딩 전략을 세워야 한다.
> 샤딩 전략에 대해 간략하게 알아보자.

- 데이터 재 샤딩
  - 데이터가 너무 많아져 하나의 샤드로는 감당하기 힘든 경우
  - 샤드 간 데이터 분포가 균등하지 못해 특정 샤드에서 공간 소모가 다른 샤드에 비해 빠른 경우
- 유명인사 문제
  - 유명인사는 한 번에 많은 사람들이 접근하게 되는데 이러한 유명인사가 하나의 샤드에 몰려 있다면 다른 샤드들에 비해 해당 샤드는 많은 부하가 발생할 것이다. 이러한 문제를 해결하기 위해 유명인사 데이터를 여러 샤드에 분산 시켜 저장하도록 한다.
- 조인과 비정규화
  - 데이터 베이스를 분산하게 되면 여러 샤드에 걸친 데이터를 조인하기가 어려워진다. 이러한 문제는 비정규화를 통해 하나의 테이블에서 질의가 수행되도록 한다.

---